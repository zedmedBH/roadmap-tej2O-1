<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Firebase Test</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
        input, button { padding: 10px; font-size: 1rem; }
        ul { list-style: none; padding: 0; }
        li { background: #f0f0f0; margin: 5px 0; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Class Guestbook ðŸŽ“</h1>

    <div id="loginSection">
        <button id="loginBtn" style="background-color: #4285F4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            Sign in with Google
        </button>
    </div>

    <div id="appSection" style="display:none;">
        <p>Welcome, <span id="userName" style="font-weight:bold;">Student</span>!</p>
        <img id="userPhoto" src="" style="width: 30px; border-radius: 50%; vertical-align: middle; margin-right: 10px;">
        <button id="logoutBtn">Sign Out</button>
        <hr>
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button id="sendBtn">Post Message</button>
    </div>

    <h3>Class Messages:</h3>
    <ul id="messageList">Loading...</ul>

    <script type="module">
        // Import Authentication functions along with Firestore
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBprGqy0WYVzIrL8XR163kWb2EcGm9ns-s",
            authDomain: "roadmap-tej2o-1.firebaseapp.com",
            projectId: "roadmap-tej2o-1",
            storageBucket: "roadmap-tej2o-1.firebasestorage.app",
            messagingSenderId: "655591889925",
            appId: "1:655591889925:web:b356cde80a5c087a26506c",
            measurementId: "G-D5NK61R1X6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // Initialize Auth
        const provider = new GoogleAuthProvider(); // Setup Google Login

        // FORCE the login popup to only show accounts from this domain
        provider.setCustomParameters({
        'hd': 'branksome.on.ca' 
        });

        // --- LOGIN LOGIC ---
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginSection = document.getElementById('loginSection');
        const appSection = document.getElementById('appSection');
        const userNameSpan = document.getElementById('userName');
        const userPhotoImg = document.getElementById('userPhoto');

        // 1. Handle Login Button Click
        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    console.log("Logged in!", result.user);
                }).catch((error) => {
                    console.error("Login failed", error);
                    alert("Login failed: " + error.message);
                });
        });

        // 2. Handle Logout
        logoutBtn.addEventListener('click', () => signOut(auth));

        // 3. Monitor Login State (Runs automatically when page loads)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                loginSection.style.display = 'none';
                appSection.style.display = 'block';
                userNameSpan.textContent = user.displayName; // Their Google Name
                userPhotoImg.src = user.photoURL; // Their Google Profile Pic
            } else {
                // User is signed out
                loginSection.style.display = 'block';
                appSection.style.display = 'none';
            }
        });

        // --- DATABASE LOGIC (Updated to save name) ---
        document.getElementById('sendBtn').addEventListener('click', async () => {
            const input = document.getElementById('messageInput');
            const messageText = input.value;
            const user = auth.currentUser; // Get the currently logged-in user

            if(messageText && user) {
                try {
                    await addDoc(collection(db, "messages"), {
                        text: messageText,
                        name: user.displayName, // Save their name!
                        email: user.email,      // Save their email!
                        uid: user.uid,          // Save their unique ID
                        timestamp: new Date()
                    });
                    input.value = ""; 
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            }
        });

        // Read Data (Same as before, but let's show the name too)
        const list = document.getElementById('messageList');
        const q = query(collection(db, "messages"), orderBy("timestamp", "desc"));
        
        onSnapshot(q, (snapshot) => {
            list.innerHTML = "";
            snapshot.forEach((doc) => {
                const data = doc.data();
                const li = document.createElement('li');
                // Display: "Name: Message"
                li.innerHTML = `<strong>${data.name || 'Anonymous'}</strong>: ${data.text}`;
                list.appendChild(li);
            });
        });
    </script>
</body>
</html>